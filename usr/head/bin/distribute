#!/bin/env oo-ruby

# args
# 1 - checksum of the artifact to distribute

require_relative '../lib/util.rb'

checksum=ARGV.shift

sync_base_dir = "#{ENV['OPENSHIFT_DATA_DIR']}/artifacts"

raise "Release #{checksum} has not been prepared yet" unless File.exist?(File.join(sync_base_dir, checksum))

say "Validating artifact checksum on head gear"
`#{ENV['OPENSHIFT_BINARYDEPLOY_DIR']}/child/bin/validate #{checksum}`
raise "Checksum validation failed on head gear" unless $?.success?

successes = []
failures = []

gears = read_gear_registry
say "# of child gears = #{gears.count}"

output = parallel(gears) do |gear|
  result = []
  result << "Distributing to #{gear.url}"

  result << "Creating artifact directory for #{checksum}"
  gear.run_if_child 'mkdir -p app-root/runtime/artifacts/#{checksum}'

  result << "Syncing artifact #{checksum}"
  result << `rsync -v --delete-after -az --rsh=ssh "#{sync_base_dir}/#{checksum}/" "#{gear.url}:app-root/runtime/artifacts/#{checksum}/"`

  result << "Validating checksum"
  gear.run_if_child 'app-root/runtime/scripts/validate #{checksum}'

  if $?.success?
    result << "Checksum validated"
    successes << uuid
  else
    result << "Checksum validation failed"
    failures << uuid
  end

  result
end

output.each_with_index do |out, index|
  uuid = gears[index].id
  say "Result from gear #{uuid}"
  out.each { |o| say "  #{o}" }
  say ""
end

say "\nSuccessful distributions: #{successes.count}"
successes.each { |uuid| say uuid }

say ""

say "Failed distributions: #{failures.count}"
failures.each { |uuid| say uuid }
